# Vibe Drive 需求规格说明书 (PRD)

## 1. 项目定位与核心愿景

- **定位**：基于通用智能体（General-purpose Agent）架构的车载空间自适应编排引擎。
- **核心目标**：打破“点播-播放”的死逻辑，利用雷石 29 年积淀的正版曲库与千万级用户行为数据，实现环境感知驱动的“时空叙事”体验。
- **口号**：让 AI 赋予百万辆车有趣的灵魂。

------

## 2. 核心功能模块 (MVP 范围)

### 2.1 智能体大脑 (The Agent Brain)

- **感知接口 (Monitor)**：支持接收模拟的 JSON 环境包，包含：
  - `GPS_Tag` (地理标签)：如"高架桥"、"隧道"、"郊区公路"、"闹市区"
  - `Weather` (天气)：晴/阴/雨/雪/雾
  - `Speed` (车速)：0-200 km/h
  - `User_Mood` (用户情绪)：happy/calm/tired/stressed/excited
  - `Time_of_Day` (时段)：dawn/morning/noon/afternoon/evening/night/midnight
  - `Passenger_Count` (乘客数量)：1-7
  - `Route_Type` (路线类型)：highway/urban/mountain/coastal/tunnel
- **推理引擎 (Analyze & Plan)**：利用 LLM 对环境数据进行语义对齐。例如：识别“深夜+雨天+高架桥”背后的“孤独/疲劳”意图，而非简单的关键字匹配。
- **编排器 (Orchestrator)**：通过 **Tool Calling** 调度音乐、灯光、文字生成等多个原子服务，输出一套连贯的“氛围方案”。

### 2.2 空间编排工具箱 (Spatial Toolbox)

- **音乐编排器**：接入模拟的雷石曲库，根据 Agent 指令筛选符合 Vibe 的歌曲元数据（BPM、流派）。
- **沉浸式叙事器**：实时生成 AIGC 串词（TTS 输出），将窗外风景与正在播放的音乐进行“时空编织”。
- **环境控制器 (Mock)**：控制模拟的氛围灯色温、座椅按摩频率、车载香氛浓度。

### 2.3 交互模式 (Interaction Mode)

- **主动推荐模式**：当感知到环境发生剧烈变化（如从闹市区进入郊区）时，Agent 主动发起氛围重构。
- **安全优先级模式**：实时监测模拟车速，在高负载驾驶状态下自动压制复杂的交互干扰。
  - **L1 正常模式** (车速 < 60 km/h)：全功能开放，支持语音交互、视觉动效、主动推荐
  - **L2 专注模式** (60 ≤ 车速 < 100 km/h)：禁用视觉动效，仅保留音频输出，降低推荐频率
  - **L3 静默模式** (车速 ≥ 100 km/h)：禁用所有主动推荐，仅响应用户主动指令，TTS 音量自动降低 30%

### 2.4 典型用户场景 (User Scenarios)

#### 场景一：深夜归途
> **环境**：midnight + 雨天 + 高架桥 + 独自驾驶 + tired
>
> **Agent 响应**：自动切换至舒缓爵士乐播放列表，氛围灯调为暖黄色（色温 2700K），座椅按摩启动轻柔模式，TTS 轻声说：「夜深了，窗外的雨声和这首歌很配，让音乐陪你安全到家。」

#### 场景二：周末家庭出游
> **环境**：morning + 晴天 + 郊区公路 + 4人乘坐 + happy
>
> **Agent 响应**：播放欢快的流行音乐，氛围灯切换为活力蓝绿渐变，TTS 说：「阳光正好，前方 15 公里有个观景台，要不要停下来拍张全家福？」

#### 场景三：通勤早高峰
> **环境**：morning + 阴天 + 闹市区 + 独自驾驶 + stressed
>
> **Agent 响应**：播放轻音乐或白噪音，氛围灯保持柔和白光，香氛释放薄荷清香提神，TTS 说：「早高峰有点堵，深呼吸，今天也会是充实的一天。」

------

## 3. 开发计划 (Development Plan)

### 3.1 Phase 1：架构与数据建模
- 定义环境数据协议（Environment JSON Schema）
- 搭建基于 LangChain4j 的 MAPE-K 闭环架构
- 设计 Agent 与 Tool 之间的接口规范

### 3.2 Phase 2：核心逻辑实现
- 实现 Agent 推理引擎，支持环境语义理解与意图识别
- 开发工具调度模块（MusicTool, LightTool, NarrativeTool）
- 编写 Prompt 模板，优化 LLM 输出质量

### 3.3 Phase 3：数据与服务集成
- 构建 Mock 环境数据生成器，模拟真实驾驶场景
- 实现后端 API 服务，对接 LLM 与各工具模块
- 集成 TTS 服务，实现串词语音输出

### 3.4 Phase 4：前端与演示
- 开发车载横屏 UI，展示实时环境感知与氛围变化
- 实现 Agent 推理过程可视化（思维链展示）
- 录制演示视频，准备项目文档

------

## 4. 技术栈选型

- **后端语言**：Java (Spring Boot 3.x)
  - 成熟的企业级框架，便于快速搭建 RESTful API
  - 丰富的生态支持（Spring AI、Spring WebFlux 等）
- **AI 框架**：LangChain4j
  - 原生支持 Tool Calling 与 Agent 编排
  - 提供 Memory 机制用于上下文管理
- **前端技术**：React + Three.js
  - React 用于构建车载横屏 UI 界面
  - Three.js 用于实现氛围灯动效的 3D 可视化
- **LLM 服务**：OpenAI GPT-4 / Claude 3.5 Sonnet
  - 支持 Function Calling，满足工具调度需求
  - 上下文窗口 ≥ 128K，支持复杂环境推理
- **开发工具**：Cursor / GitHub Copilot（AI 辅助编程）

------

## 5. 非功能性需求 (Non-Functional Requirements)

### 5.1 性能要求

| **指标**             | **目标值**       | **说明**                           |
| -------------------- | ---------------- | ---------------------------------- |
| LLM 响应延迟         | < 3 秒           | 从环境变化到氛围方案输出的端到端延迟 |
| 环境感知刷新频率     | 1 次/秒          | 模拟传感器数据更新频率             |
| 前端渲染帧率         | ≥ 30 FPS         | 氛围灯动效流畅度                   |
| 并发用户支持（Demo） | ≥ 10             | 演示环境下的并发能力               |

### 5.2 可靠性与容错

- **LLM 降级策略**：当 LLM API 超时或不可用时，自动切换至预设的规则引擎（基于环境标签的静态映射表）
- **数据校验**：对输入的 Environment JSON 进行 Schema 校验，非法数据自动丢弃并记录日志
- **状态恢复**：系统重启后自动恢复上一次的氛围状态

### 5.3 安全性

- **API 密钥管理**：LLM API Key 通过环境变量注入，禁止硬编码
- **输入过滤**：对用户语音输入进行敏感词过滤，防止 Prompt 注入攻击
- **日志脱敏**：用户位置等隐私数据在日志中进行脱敏处理

### 5.4 可扩展性

- **工具插件化**：新增硬件控制器（如车窗、天窗）时，只需实现统一的 Tool 接口
- **多 LLM 支持**：预留 LLM Provider 抽象层，支持快速切换不同模型（GPT-4、Claude、文心等）

------

## 6. 项目核心价值

### 6.1 技术创新性

- **时空叙事引擎**：突破传统车载娱乐"点播-播放"的单向模式，通过 Agent 架构实现环境感知驱动的内容编排
- **跨模态编排能力**：Agent 可同时调度音乐、灯光、香氛、TTS 等多个硬件模块，实现"涌现式"的氛围体验
- **语义理解而非规则匹配**：利用 LLM 的语义推理能力，识别"深夜+雨天+高架桥"背后的情感意图，而非简单的 if-else 逻辑

### 6.2 商业价值

- **激活存量资源**：充分利用雷石 29 年积累的正版曲库与 7000 万用户行为数据
- **提升内容消费深度**：从"被动点播"转向"主动推荐"，延长用户在车内的内容消费时长
- **差异化竞争优势**：在同质化的车载娱乐市场中，通过 AI 原生体验建立技术壁垒

### 6.3 实现完整性

- **闭环验证**：完整实现"感知 → 推理 → 编排 → 执行"的 MAPE-K 闭环
- **可演示性**：通过可视化界面展示 Agent 的推理过程（思维链）
- **可扩展性**：预留工具插件接口，支持快速接入新的硬件控制器