# 语音系统架构设计

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端 (Vue)                               │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │ vibeStore   │───▶│ ttsService  │───▶│ AudioPlayer │         │
│  │ (监听叙事)   │    │ (请求音频)   │    │ (流式播放)   │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ SSE / fetch stream
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       后端 (Spring Boot)                         │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │ TtsController│───▶│ TtsService  │───▶│EdgeTtsClient│         │
│  │ (API入口)    │    │ (业务逻辑)   │    │ (调用TTS)   │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ WebSocket
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Edge TTS API                                │
│                  (微软语音合成服务)                                │
└─────────────────────────────────────────────────────────────────┘
```

## 数据流

### 触发流程

```
1. AI 调用 generateNarrative 工具
2. 返回 Narrative 对象 (text, emotion)
3. 前端收到 tool_end 事件
4. 提取叙事文本
5. 调用 TTS API
6. 流式播放音频
```

### 时序图

```
┌──────┐     ┌──────┐     ┌──────┐     ┌──────┐     ┌──────┐
│ AI   │     │ 后端  │     │ 前端  │     │ TTS  │     │Audio │
└──┬───┘     └──┬───┘     └──┬───┘     └──┬───┘     └──┬───┘
   │            │            │            │            │
   │ narrative  │            │            │            │
   │───────────▶│            │            │            │
   │            │ tool_end   │            │            │
   │            │───────────▶│            │            │
   │            │            │ POST /tts  │            │
   │            │            │───────────▶│            │
   │            │            │            │ stream     │
   │            │            │◀───────────│            │
   │            │            │ audio chunk│            │
   │            │            │───────────────────────▶│
   │            │            │            │      play  │
   │            │            │            │            │
```
