# 探索文档：主智能体响应优化

## 背景

当前主智能体（Master Agent）实现存在响应延迟问题：
- AI 既要聊天又要控制设备
- ReAct 模式下多次工具调用导致等待时间长
- 用户体验：长时间无反馈

## 问题分析

### 当前架构

```
用户输入 → 主智能体 → [say + 多个控制工具] → 响应
                         ↑
                    串行执行，等待每个工具完成
```

### 延迟来源

1. **LLM 推理时间**：每次工具调用后需要重新推理
2. **工具执行时间**：音乐搜索、API 调用等
3. **多轮循环**：ReAct 模式可能多次循环
4. **say 工具调用过多**：AI 倾向于多次调用 say

---

## 优化方案

### 方案 1：非 ReAct 模式（一次性控制）

**思路**：不使用工具循环，一次性生成所有操作指令

```
用户输入 → LLM 一次性输出 JSON → 解析执行
```

**优点**：
- 响应速度最快（1 次 LLM 调用）
- 实现简单

**缺点**：
- 无法处理复杂多步骤任务
- 无法根据工具结果调整后续操作
- 需要自定义输出解析

**适用场景**：简单指令（"播放音乐"、"开灯"）

---

### 方案 2：先对话再操作

**思路**：通过 Prompt 约束，让 AI 先回复用户，再执行操作

```
用户输入 → 主智能体 → 1. say("好的") → 2. 执行操作
                              ↑
                         用户立即听到回复
```

**优点**：
- 用户体验好，立即得到反馈
- 保持 ReAct 灵活性
- 实现改动小（只改 Prompt）

**缺点**：
- 依赖 Prompt 约束，AI 可能不遵守
- 操作失败时用户已收到"成功"回复

**实现方式**：
```
## 重要规则
1. 收到用户请求后，必须先调用 say 工具回复用户
2. 回复后再执行具体操作
3. 操作完成后不需要再次回复
```

---

### 方案 3：委派式智能体

**思路**：主智能体只负责对话，将操作委派给氛围智能体

```
用户输入 → 主智能体 → say("好的，正在为您编排")
                   ↓
              callVibeAgent(异步) → 氛围智能体执行
```

**优点**：
- 职责分离清晰
- 主智能体响应快
- 氛围智能体专注复杂编排

**缺点**：
- 架构更复杂
- 需要协调两个智能体
- 简单操作也要经过委派

**变体**：主智能体保留简单操作能力
- 简单指令（设置灯光）：直接执行
- 复杂编排（营造氛围）：委派给氛围智能体

---

### 方案 4：混合模式（推荐）

**思路**：结合方案 2 和方案 3

```
用户: "帮我放松一下"
    ↓
主智能体:
  1. say("好的，我来为您营造放松氛围")  ← 立即回复
  2. callVibeAgent("放松氛围", async=true) ← 异步委派
    ↓
用户立即听到回复
氛围在后台编排，完成后推送结果
```

**核心改动**：
1. Prompt 强调"先说后做"
2. `callVibeAgent` 改为异步执行
3. 主智能体只保留 `say` + `callVibeAgent` + 简单查询工具

---

## 实验计划

### 实验 1：Prompt 优化（方案 2）

**目标**：通过 Prompt 约束实现"先说后做"

**改动**：
- 修改 `master-system.txt`
- 强调 say 工具优先级

**验证**：
- [ ] AI 是否先调用 say
- [ ] 响应延迟是否改善

### 实验 2：异步委派（方案 3/4）

**目标**：callVibeAgent 异步执行

**改动**：
- CallVibeAgentTool 改为异步
- 添加完成通知机制

**验证**：
- [ ] 主智能体响应时间
- [ ] 氛围编排是否正常完成

### 实验 3：工具精简

**目标**：减少主智能体的工具数量

**改动**：
- 移除直接控制工具（setLight、setScent 等）
- 只保留：say、callVibeAgent、getEnvironment、getProjectIntro

**验证**：
- [ ] 是否影响简单指令处理
- [ ] 响应速度是否提升

---

## 决策记录

| 日期 | 决策 | 原因 |
|------|------|------|
| 2024-12-27 | 待定 | 需要实验验证 |

---

## 参考

- [探索文档-主智能体设计.md](./探索文档-主智能体设计.md)
- [探索文档-Agent优化.md](./探索文档-Agent优化.md)
