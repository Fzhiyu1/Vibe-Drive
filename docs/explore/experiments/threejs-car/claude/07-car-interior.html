<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试07：车内场景</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        canvas { display: block; }
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        .color-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .color-btn:hover { transform: scale(1.1); }
        .color-btn.active { border-width: 4px; }
        .toggle-btn {
            padding: 10px 20px;
            background: #333;
            color: #fff;
            border: 2px solid #fff;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        .toggle-btn.active { background: #00aaff; }
    </style>
</head>
<body>
    <div class="controls">
        <button class="color-btn" style="background: #ff0000;" data-color="0xff0000"></button>
        <button class="color-btn active" style="background: #00aaff;" data-color="0x00aaff"></button>
        <button class="color-btn" style="background: #00ff00;" data-color="0x00ff00"></button>
        <button class="color-btn" style="background: #aa00ff;" data-color="0xaa00ff"></button>
        <button class="toggle-btn active" id="breathToggle">呼吸效果</button>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // 场景设置
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);

        // 相机设置 - 驾驶员视角
        const camera = new THREE.PerspectiveCamera(75, 1200 / 600, 0.1, 1000);
        camera.position.set(0, 1.2, 0.5);
        camera.lookAt(0, 1, -2);

        // 渲染器设置
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(1200, 600);
        document.body.appendChild(renderer.domElement);

        // 氛围灯材质数组
        const ambientLightMaterials = [];
        let currentColor = new THREE.Color(0x00aaff);

        // 创建氛围灯带
        function createAmbientStrip(width, height, position, rotation = [0, 0, 0]) {
            const geometry = new THREE.PlaneGeometry(width, height);
            const material = new THREE.MeshBasicMaterial({
                color: currentColor.clone(),
                side: THREE.DoubleSide,
                transparent: true
            });
            ambientLightMaterials.push(material);
            const strip = new THREE.Mesh(geometry, material);
            strip.position.set(...position);
            strip.rotation.set(...rotation);
            return strip;
        }

        // 车厢内部材质
        const interiorMaterial = new THREE.MeshStandardMaterial({
            color: 0x1a1a1a,
            roughness: 0.9
        });
        const dashMaterial = new THREE.MeshStandardMaterial({
            color: 0x2a2a2a,
            roughness: 0.7
        });
        const seatMaterial = new THREE.MeshStandardMaterial({
            color: 0x333333,
            roughness: 0.6
        });

        // 车厢外壳（简化为内部空间）
        const cabinGeo = new THREE.BoxGeometry(3, 1.5, 4);
        const cabin = new THREE.Mesh(cabinGeo, interiorMaterial);
        cabin.position.set(0, 0.75, -1);
        scene.add(cabin);

        // 仪表台
        const dashGeo = new THREE.BoxGeometry(2.8, 0.4, 0.6);
        const dashboard = new THREE.Mesh(dashGeo, dashMaterial);
        dashboard.position.set(0, 0.9, -2.5);
        scene.add(dashboard);

        // 中控屏（发光平面）
        const screenGeo = new THREE.PlaneGeometry(0.6, 0.4);
        const screenMaterial = new THREE.MeshBasicMaterial({
            color: 0x4488ff,
            emissive: 0x4488ff
        });
        const screen = new THREE.Mesh(screenGeo, screenMaterial);
        screen.position.set(0.3, 1.1, -2.19);
        scene.add(screen);

        // 方向盘（圆环）
        const wheelGeo = new THREE.TorusGeometry(0.18, 0.025, 16, 32);
        const wheelMaterial = new THREE.MeshStandardMaterial({ color: 0x222222 });
        const steeringWheel = new THREE.Mesh(wheelGeo, wheelMaterial);
        steeringWheel.position.set(-0.4, 1.0, -1.8);
        steeringWheel.rotation.x = Math.PI / 6;
        scene.add(steeringWheel);

        // 座椅
        const seatGeo = new THREE.BoxGeometry(0.5, 0.6, 0.5);
        const leftSeat = new THREE.Mesh(seatGeo, seatMaterial);
        leftSeat.position.set(-0.5, 0.5, 0);
        scene.add(leftSeat);

        const rightSeat = new THREE.Mesh(seatGeo, seatMaterial);
        rightSeat.position.set(0.5, 0.5, 0);
        scene.add(rightSeat);

        // 座椅靠背
        const backGeo = new THREE.BoxGeometry(0.5, 0.7, 0.15);
        const leftBack = new THREE.Mesh(backGeo, seatMaterial);
        leftBack.position.set(-0.5, 0.95, -0.2);
        scene.add(leftBack);

        const rightBack = new THREE.Mesh(backGeo, seatMaterial);
        rightBack.position.set(0.5, 0.95, -0.2);
        scene.add(rightBack);

        // 氛围灯带 - 仪表台下沿
        const dashStrip = createAmbientStrip(2.5, 0.05, [0, 0.7, -2.2]);
        scene.add(dashStrip);

        // 氛围灯带 - 左车门
        const leftDoorStrip = createAmbientStrip(0.05, 1.2, [-1.4, 0.8, -1], [0, Math.PI / 2, 0]);
        scene.add(leftDoorStrip);

        // 氛围灯带 - 右车门
        const rightDoorStrip = createAmbientStrip(0.05, 1.2, [1.4, 0.8, -1], [0, Math.PI / 2, 0]);
        scene.add(rightDoorStrip);

        // 环境光（微弱）
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.1);
        scene.add(ambientLight);

        // OrbitControls（限制角度）
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.target.set(0, 1, -2);
        controls.minPolarAngle = Math.PI / 4;
        controls.maxPolarAngle = Math.PI / 2;
        controls.minDistance = 0.5;
        controls.maxDistance = 3;

        // 呼吸效果状态
        let breathingEnabled = true;
        let breathPhase = 0;

        // 颜色切换
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const colorValue = parseInt(btn.dataset.color);
                currentColor.setHex(colorValue);
                ambientLightMaterials.forEach(mat => mat.color.setHex(colorValue));
            });
        });

        // 呼吸效果开关
        document.getElementById('breathToggle').addEventListener('click', (e) => {
            breathingEnabled = !breathingEnabled;
            e.target.classList.toggle('active');
        });

        // 动画循环
        function animate() {
            requestAnimationFrame(animate);

            if (breathingEnabled) {
                breathPhase += 0.03;
                const intensity = 0.3 + 0.7 * (0.5 + 0.5 * Math.sin(breathPhase));
                ambientLightMaterials.forEach(mat => mat.opacity = intensity);
            } else {
                ambientLightMaterials.forEach(mat => mat.opacity = 1);
            }

            controls.update();
            renderer.render(scene, camera);
        }

        animate();
    </script>
</body>
</html>
