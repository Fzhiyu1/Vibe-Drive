# 探索文档：Agent 优化

## 探索目标

研究如何优化 Vibe Drive 项目中的 AI Agent，包括：
- Prompt 优化
- Tool 设计优化
- 响应质量提升
- 性能与成本优化

## 背景

当前 Vibe Drive 项目使用 LangChain4j 实现 AI Agent，通过 ReAct 模式调用多个 Tool 完成氛围编排。

**现有 Tool**：
- `LightTool` - 氛围灯控制
- `MusicTool` - 音乐搜索与播放
- `ScentTool` - 香氛控制
- `NarrativeTool` - 叙事生成

## 待探索内容

- [ ] 当前 Agent 问题分析
- [ ] Prompt 优化方案
- [ ] Tool 调用策略优化
- [ ] 响应质量评估
- [ ] 成本与延迟优化

---

## 探索记录

### 话题1：音乐搜索关键词单一问题

**讨论日期**：2025-12-25

**问题**：AI 搜索音乐时总是用差不多的关键词，导致推荐的歌曲重复。

#### 1.1 问题根因分析

**问题1：System Prompt 过时**

`vibe-system.txt` 第7行：
```
- recommendMusic: 根据情绪、时段、乘客数推荐音乐
```
但实际已改为 `searchMusic` + `playMusic`，AI 不知道新流程。

**问题2：@Tool 描述缺乏指导**

```java
@Tool("搜索音乐。返回候选列表供选择...")
public SearchResult searchMusic(@P("搜索关键词") String keyword)
```
没有告诉 AI：
- 应该用什么样的关键词？
- 如何根据场景构造搜索词？

**问题3：缺少音乐选择策略**

AI 不知道：
- 搜索具体歌名 vs 搜索风格关键词？
- 不同场景应该用什么搜索策略？

#### 1.2 解决方案

**方案A：更新 System Prompt**

在 `vibe-system.txt` 中添加音乐搜索指导：

```
## 音乐搜索策略

使用 searchMusic 搜索音乐时，请遵循以下策略：

### 关键词构造规则
1. **具体歌曲优先**：如果场景适合某首经典歌曲，直接搜索歌名+歌手
   - 例：夜间高速 → "夜空中最亮的星 逃跑计划"
   - 例：雨天 → "雨的印记 李闰珉"

2. **风格+场景组合**：没有具体歌曲时，用风格+场景关键词
   - 例：清晨通勤 → "轻快 早晨 纯音乐"
   - 例：海边日落 → "海边 日落 轻音乐"

3. **避免过于通用**：不要只用 "放松音乐"、"轻松钢琴" 这类词
   - ❌ "放松音乐"
   - ✅ "班得瑞 清晨"、"久石让 天空之城"

### 场景-音乐映射参考
| 场景 | 推荐搜索词示例 |
|------|---------------|
| 夜间高速 | "夜空中最亮的星"、"平凡之路"、"后来" |
| 雨天城市 | "雨的印记"、"Kiss The Rain"、"夜曲" |
| 清晨通勤 | "早安 轻音乐"、"Morning"、"新的一天" |
| 海边日落 | "海边 日落"、"Ocean"、"夏天的风" |
| 山间公路 | "山路十八弯"、"在路上"、"远方" |
| 疲劳驾驶 | "提神 节奏感"、"Wake Up"、"动感音乐" |
```

**方案B：增强 @Tool 描述**

在 MusicTool 的 @Tool 注解中添加更详细的指导。

**方案C：Few-shot 示例**

在 System Prompt 中添加几个完整的搜索示例。

#### 1.3 搜索接口验证

**验证日期**：2025-12-25

| 关键词 | 结果 | 状态 |
|--------|------|------|
| 夜空中最亮的星 | 夜空中最亮的星 - 逃跑计划 | ✅ 正确 |
| 久石让 | 返回久石让相关歌曲 | ✅ 正确 |
| 放松音乐 | 千与千寻主题曲 | ✅ 有结果 |
| 周杰伦 | 返回周杰伦歌曲 | ✅ 正确 |

**结论**：Go 微服务搜索接口正常，问题确认在 AI 提示词/策略上。

#### 1.4 推荐方案

**推荐：方案A + 方案C 结合**

1. 更新 System Prompt，添加音乐搜索策略
2. 添加 2-3 个 Few-shot 示例
3. 保持 @Tool 描述简洁（避免过长）

---

### 话题2：AI 未利用环境细节数据

**讨论日期**：2025-12-26

**问题**：环境数据包含丰富的细节，但 AI 生成的关键词仍然单一。

#### 2.1 收敛性测试

使用测试脚本 `docs/explore/experiments/agent-music-test/test.js` 进行测试。

**测试结果**：

| 场景 | AI 生成的关键词 | 问题 |
|------|----------------|------|
| 夜间高速 ×7 | "夜间驾驶 放松 纯音乐" | 完全相同 |
| 雨天下午 ×3 | "雨天 轻音乐 放松" | 完全相同 |

**结论**：AI 生成的关键词高度收敛，缺乏多样性。

#### 2.2 根因分析

**System Prompt 只说明了粗粒度字段**：

```
- gpsTag: highway/urban/suburban...
- weather: sunny/cloudy/rainy...
- timeOfDay: night/morning...
- userMood: calm/happy/tired...
```

**但实际环境数据包含更多细节**（AI 不知道如何使用）：

| 字段 | 示例值 | 潜在用途 |
|------|--------|----------|
| `location.cityName` | 上海市 | 推荐《夜上海》 |
| `location.roadName` | 沪杭高速 | 推荐杭州相关歌曲 |
| `biometrics.stressLevel` | 0.48 | 高压力→更舒缓的音乐 |
| `biometrics.fatigueLevel` | 0.82 | 高疲劳→更提神的音乐 |
| `nearbyPois` | 服务区、餐厅 | 结合地点推荐 |

#### 2.3 解决方案

**更新 System Prompt**，添加细节字段说明和使用指导：

1. 补充完整的环境数据字段说明
2. 指导 AI 如何利用细节数据增加推荐多样性
3. 强调搜索具体歌名而非通用描述词

---

## 实验记录

### 实验1：收敛性测试

**日期**：2025-12-26

**文件**：`docs/explore/experiments/agent-music-test/test.js`

**结论**：AI 关键词高度收敛，需要优化提示词。

---

### 沟通记录：理解偏差

**日期**：2025-12-26

#### 冲突1：测试目标理解错误

**用户意图**：测试 AI 模型生成的搜索关键词是否收敛

**我的错误理解**：测试最终搜索到的歌曲是否重复

**差异**：
- 用户关注的是 **AI 模型的输出**（关键词）
- 我关注的是 **搜索 API 的结果**（歌曲）

**教训**：区分"模型行为"和"系统行为"

#### 冲突2：脚本用途理解错误

**用户意图**：创建脚本直接调用 DeepSeek API，测试模型本身

**我的错误理解**：创建脚本调用后端 API，测试完整流程

**差异**：
- 用户想要**隔离测试**模型行为
- 我做的是**集成测试**整个系统

**教训**：明确测试的边界和目标

#### 冲突3：环境随机性的理解

**用户提问**：环境本身就有随机性，为什么还会生成相同的关键词？

**正确理解**：
- 环境数据包含丰富的细节（城市、道路、压力值等）
- 但 System Prompt 没有告诉 AI 这些字段的存在
- 所以 AI 只看到粗粒度标签，忽略了细节

**教训**：问题可能出在"信息传递"而非"信息本身"

---

## 参考资源

- [LangChain4j 文档](https://docs.langchain4j.dev/)
- [Anthropic Prompt Engineering](https://docs.anthropic.com/claude/docs/prompt-engineering)
