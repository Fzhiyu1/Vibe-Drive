# 阶段 2: 设计文档

## 状态

🟢 已完成

## 目标

在编码之前完成系统设计，输出完整的设计文档，为后续开发提供明确指导。

## 前置依赖

- [x] 阶段 1: 项目初始化
- [x] 需求规格说明书

## 任务清单

### 系统架构设计

- [x] 绘制系统架构图（MAPE-K 闭环）
- [x] 绘制模块关系图（Agent、Tools、API、Frontend）
- [x] 绘制数据流图（环境数据 → Agent → 氛围方案）
- [x] 定义模块职责边界

### 数据模型设计

- [x] 定义 Environment JSON Schema
- [x] 定义 AmbiencePlan JSON Schema
- [x] 定义 MusicRecommendation Schema
- [x] 定义 LightSetting Schema
- [x] 定义所有枚举类型及取值

### API 接口设计

- [x] 设计 RESTful API 规范
- [x] 定义请求/响应格式
- [x] 定义错误码规范
- [x] 编写 OpenAPI/Swagger 文档（可选）

### Tool 接口设计

- [x] MusicTool 接口定义
- [x] LightTool 接口定义
- [x] NarrativeTool 接口定义

### Agent Prompt 设计

- [x] 编写 System Prompt 草稿
- [x] 设计 Few-shot 示例

### 前端界面设计

- [x] 绘制 UI 线框图（Wireframe）
- [x] 定义页面布局（车载横屏）
- [x] 定义组件结构

## 输出文档

```
docs/design/
├── architecture.md          # 系统架构设计 ✅ (已重构)
├── data-model.md            # 数据模型设计 ✅ (已增强)
├── api-spec.md              # API 接口规范 ✅
├── tool-interface.md        # Tool 接口设计 ✅ (已重构)
├── prompt-design.md         # Agent Prompt 设计 ✅ (已重构)
├── ui-wireframe.md          # 前端界面设计 ✅
└── refactoring-guide.md     # 重构指南 ✅ (新增)
```

## 完成标准

- [x] 所有设计文档编写完成
- [ ] 团队/自己 Review 通过
- [ ] 文档已提交到 Git

## 问题与笔记

### 架构决策记录

1. **双智能体异步架构**：主智能体负责用户交互，Vibe Agent 专注氛围编排
2. **内置会话隔离**：使用 LangChain4j `@MemoryId` + `ChatMemoryProvider` 隔离会话与管理窗口记忆（弃用自研 Fork-Merge）
3. **主智能体预留**：接口已定义，Mock 实现，后续阶段补充
4. **安全模式前置过滤**：在调用 Agent 前判断安全模式，确保驾驶安全
